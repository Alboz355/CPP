workflows:
  ios_unsigned_build:
    name: iOS Unsigned Build
    instance_type: mac_mini_m1 
    environment:
      vars:
        XCODE_SCHEME: "App"
    
    scripts:
      - name: Set up Node.js and npm
        script: |
          echo "--- Node.js and npm versions ---"
          node -v
          npm -v
          echo "--------------------------------"
      
      - name: Install dependencies
        script: |
          echo "--- Installing npm dependencies ---"
          npm ci
          echo "--- Verifying Capacitor CLI presence ---"
          if [ -f "$(npm bin)/cap" ]; then
            echo "Capacitor CLI found at $(npm bin)/cap"
          else
            echo "Capacitor CLI NOT found. Please ensure @capacitor/cli is in your devDependencies."
            exit 1
          fi
          echo "----------------------------------------"
      
      - name: Build the web app
        script: |
          echo "--- Building the web app (Next.js) ---"
          # Ce script va maintenant exécuter "next build && next export"
          npm run build
          echo "--- Listing contents of 'out' directory (Next.js build output) ---"
          ls -la out/ # Vérifie que les fichiers statiques sont bien générés
          echo "-------------------------------------------------------------------"
      
      - name: Sync Capacitor with iOS
        script: |
          echo "--- Syncing Capacitor with iOS project ---"
          $(npm bin)/cap sync ios
          echo "--- Listing contents of 'ios' directory after sync ---"
          ls -la ios/ # Vérifie que les fichiers iOS ont été mis à jour
          echo "------------------------------------------------------"
      
      - name: Install CocoaPods
        script: |
          echo "--- Installing CocoaPods dependencies ---"
          cd ios
          pod install
          echo "-----------------------------------------"
      
      - name: Build iOS unsigned .ipa
        script: |
          echo "--- Building iOS unsigned .ipa ---"
          xcode-project build \
            --scheme "$XCODE_SCHEME" \
            --project "ios/$XCODE_SCHEME.xcodeproj" \
            --artifact-type ipa \
            --no-codesign
          echo "----------------------------------"
            
    artifacts:
      - $CM_BUILD_DIR/**/*.ipa
